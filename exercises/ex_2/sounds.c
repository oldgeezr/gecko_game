#include <stdint.h>
#include "efm32gg.h"
#include "sounds.h"
#include "dac.h"
#include "math.h"
#include "song.h"
//#include "battle003.h"

static inline uint16_t dacOutputLevel(uint16_t amplitude, double angle, double N) {
	return (amplitude + amplitude*sin(((2*PI)/N)*angle));
}

#define ARRLEN 10
uint16_t test_sounds[10] = {A, B, Bb, C, D, E, Eb, F, G, X };

uint16_t song_of_storms[23][2] = {
	{293, 500},
	{349, 500}, 
	{587, 2000}, 
	{293, 500}, 
	{349, 500},
	{587, 2000}, 
	{659, 900}, 
	{698, 500},
	{659, 500}, 
	{698, 500}, 
	{659, 500}, 
	{523, 500}, 
	{440, 2000}, 
	{440, 2000}, 
	{293, 2000}, 
	{293, 2000},
	{349, 500}, 
	{440, 500}, 
	{440, 500}, 
	{293, 500}, 
	{349, 500}, 
	{391, 500}, 
	{329, 500}
} ;

uint16_t mario_theme[23][2] = {
	{E, 1000},
	{E, 1000}, 
	{E, 1000}, 
	{C, 1000}, 
	{E, 1000},
	{G, 1000}, 
	{C, 1000}, 
	{G, 1000},
	{E, 1000}, 
	{A, 1000}, 
	{Bb,1000}, 
	{A, 1000}, 
	{G, 1000}, 
	{C, 1000}, 
	{E, 1000}, 
	{A, 1000},
	{F, 1000}, 
	{G, 1000}, 
	{E, 1000}, 
	{E, 1000}, 
	{F, 1000}, 
	{D, 1000}, 
	{D, 1000}
} ;

uint16_t mario[218][2] = {
{660,210},
{0,14},
{660,210},
{0,14},
{660,210},
{0,100},
{510,210},
{0,14},
{660,210},
{0,14},
{770,210},
{0,171},
{380,210},
{0,285},
{510,210},
{0,142},
{380,210},
{0,142},
{320,210},
{0,71},
{440,210},
{0,42},
{480,168},
{0,42},
{450,210},
{0,42},
{430,210},
{0,171},
{380,210},
{0,71},
{660,168},
{0,28},
{760,105},
{0,21},
{860,210},
{0,57},
{700,168},
{0,21},
{760,105},
{0,28},
{660,168},
{0,28},
{520,168},
{0,71},
{580,168},
{0,21},
{480,168},
{0,128},
{510,210},
{0,64},
{380,210},
{0,57},
{320,210},
{0,71},
{440,210},
{0,42},
{480,168},
{0,47},
{450,210},
{0,21},
{430,210},
{0,42},
{380,210},
{0,28},
{660,168},
{0,28},
{760,105},
{0,21},
{860,210},
{0,42},
{700,168},
{0,21},
{760,105},
{0,50},
{660,168},
{0,42},
{520,168},
{0,21},
{580,168},
{0,21},
{480,168},
{0,128},
{500,210},
{0,114},
{760,210},
{0,14},
{720,210},
{0,21},
{680,210},
{0,21},
{620,315},
{0,85},
{650,315},
{0,42},
{380,210},
{0,21},
{430,210},
{0,57},
{500,210},
{0,42},
{430,210},
{0,21},
{500,210},
{0,14},
{570,210},
{0,64},
{500,210},
{0,64},
{760,210},
{0,14},
{720,210},
{0,21},
{680,210},
{0,21},
{620,315},
{0,57},
{650,420},
{0,57},
{1020,168},
{0,42},
{1020,168},
{0,21},
{1020,168},
{0,57},
{380,210},
{0,42},
{500,210},
{0,57},
{760,210},
{0,14},
{720,210},
{0,21},
{680,210},
{0,21},
{620,315},
{0,71},
{650,315},
{0,42},
{380,210},
{0,21},
{430,210},
{0,57},
{500,210},
{0,42},
{430,210},
{0,21},
{500,210},
{0,14},
{570,210},
{0,60},
{585,210},
{0,64},
{550,210},
{0,60},
{500,210},
{0,71},
{380,210},
{0,42},
{500,210},
{0,42},
{500,210},
{0,42},
{500,210},
{0,21},
{580,168},
{0,50},
{660,168},
{0,21},
{500,168},
{0,42},
{430,168},
{0,21},
{380,168},
{0,85},
{500,126},
{0,21},
{500,168},
{0,42},
{500,126},
{0,50},
{500,168},
{0,21},
{580,168},
{0,21},
{660,168},
{0,107},
{500,126},
{0,21},
{500,168},
{0,42},
{500,126},
{0,50},
{500,168},
{0,21},
{580,168},
{0,50},
{660,168},
{0,21},
{500,168},
{0,42},
{430,168},
{0,21},
{380,168},
{0,114},
{660,210},
{0,21},
{660,210},
{0,42},
{660,210},
{0,42},
{510,210},
{0,14},
{660,210},
{0,42},
{770,210},
{0,78},
{380,210},
{0,82},
};

volatile void playSongArray(void) 
{  
  static volatile uint16_t cnt = 0;
  static volatile uint16_t j = 0;

  if (cnt == (song_of_storms[j][1])+250) {
  	cnt = 0;
  	j++;
  	j = j % 218;
  }
  playTone(song_of_storms[j][0]);
  cnt++;
}

volatile void playTone(uint16_t tone_freq)
{
	static volatile uint16_t i = 0;
	uint16_t N = SAMPLING_FREQ/(tone_freq*10);
	writeDAC(dacOutputLevel(250,i,N));
	i = i % N;
	i++;
}

volatile void playSquare(uint16_t tone)
{
	uint16_t N = (2*SAMPLING_FREQ)/tone;

	static uint16_t i = 0;

	if (i < N/2)
	{
		writeDAC(500);
	}
	else {
		writeDAC(0);
	}
	i %= N;
	i++;
}
